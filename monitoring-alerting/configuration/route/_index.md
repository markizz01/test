Конфигурация маршрута — это раздел пользовательского ресурса Alertmanager, который управляет тем, как оповещения, запускаемые Prometheus, группируются и фильтруются до того, как они достигнут получателя.

При изменении маршрута оператор Prometheus заново создает пользовательский ресурс Alertmanager, чтобы отразить изменения.

Дополнительные сведения о настройке маршрутов см. в официальной документации [Alertmanager.](https://prometheus.io/docs/alerting/latest/configuration/#route)

В этом разделе предполагается, что вы знакомы с тем, как компоненты мониторинга работают вместе. Для получения дополнительной информации см. [этот раздел.](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/monitoring-alerting/configuration/route/%7B%7B%3Cbaseurl%3E%7D%7D/rancher/v2.6/en/monitoring-alerting/how-monitoring-works)
-	Ограничения маршрута
-	Конфигурация маршрута
    +	Получатель
    +	Группировка
    +	Соответствие

# Ограничения маршрута

Alertmanager прокси серверы оповещают Prometheus о его получателях и дереве маршрутизации, которое фильтрует оповещения для определенных получателей на основе меток.

Драйверы оповещения сообщают о получателях для Alertmanager, являющихся неродными, например, об этих Microsoft Teams и SMS.

В пользовательском интерфейсе Rancher для настройки маршрутов и приемников можно настроить деревья маршрутизации с одним корнем, а затем глубину еще на один уровень, для дерева с глубиной два. Но если вы используете маршрут continue при настройке Alertmanager напрямую, вы можете сделать дерево глубже.
Каждый приемник предназначен для одного или нескольких поставщиков уведомлений. Поэтому, если вы знаете, что каждое оповещение для Slack также должно отправляться в PagerDuty, вы можете настроить оба в одном и том же приемнике.

# Конфигурация маршрута
## Примечание по меткам и аннотациям

Метки следует использовать для идентификации информации, которая может повлиять на маршрутизацию уведомлений. Идентифицирующая информация об оповещении может состоять из имени контейнера или имени команды, которая должна быть уведомлена.

Аннотации следует использовать для информации, которая не влияет на то, кто получает оповещение, например URL-адрес модуля Runbook или сообщение об ошибке.

# Получатель
Маршрут должен относиться к приемнику , который уже настроен.

# Группировка
**Rancher v2.6.5+**
***Примечание:** Начиная с Rancher v2.6.5 Group By теперь принимает список строк вместо пар ключ-значение. Подробности смотрите в исходной [документации .](https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#route).* 
|Поле	|По умолчанию	|Описание|
|-|-|-|
|Group By|	N/a	|Список ярлыков для группировки. Метки не должны повторяться (уникальный список). Специальная метка "..." (агрегация по всем возможным меткам), если она указана, должна быть единственным элементом в списке.|
|Групповое ожидание|	30s|	Как долго ждать буферизации предупреждений одной и той же группы перед отправкой.|
|Групповой интервал|	5m	|Сколько времени ждать перед отправкой оповещения, которое было добавлено в группу оповещений, для которых уже было отправлено первоначальное уведомление.|
|Интервал повтора	|4h|	Как долго ждать перед повторной отправкой данного оповещения, которое уже было отправлено.|

**Rancher до v2.6.5**

|Поле	|По умолчанию	|Описание|
|-|-|-|
|Group By	|N/a	|Ярлыки, по которым группируются входящие оповещения. Например, [ group_by: '[' <labelname>, ... ']' ]несколько предупреждений, поступающих для меток, таких как cluster=Aи alertname=LatencyHigh, могут быть объединены в одну группу. Для агрегирования по всем возможным меткам используйте специальное значение '...'в качестве единственного имени метки, например: group_by: ['...'] Группировка по ...эффективно полностью отключает агрегацию, пропуская все оповещения как есть. Вряд ли это то, что вам нужно, если только у вас не очень низкий объем предупреждений или ваша вышестоящая система уведомлений не выполняет собственную группировку.
|Групповое ожидание|	30s	|Как долго ждать буферизации предупреждений одной и той же группы перед отправкой.|
|Групповой интервал|	5m	|Сколько времени ждать перед отправкой оповещения, которое было добавлено в группу оповещений, для которых уже было отправлено первоначальное уведомление.|
|Интервал повтора	|4h	|Как долго ждать перед повторной отправкой данного оповещения, которое уже было отправлено.|

# Матчинг(Matching)

Поле **«Match (Сопоставление)»** относится к набору сопоставителей равенства, используемых для определения того, какие предупреждения следует отправлять на данный маршрут, на основе меток, определенных для этого предупреждения. Когда вы добавляете пары ключ-значение в пользовательский интерфейс Rancher, они соответствуют YAML в следующем формате:
```
match:
  [ <labelname>: <labelvalue>, ... ]
```
Поле **Match Regex** относится к набору средств сопоставления регулярных выражений, используемых для определения того, какие оповещения следует отправлять на данный маршрут на основе меток, определенных для этого оповещения. Когда вы добавляете пары ключ-значение в пользовательский интерфейс Rancher, они соответствуют YAML в следующем формате:
```
match_re:
  [ <labelname>: <regex>, ... ]
```
