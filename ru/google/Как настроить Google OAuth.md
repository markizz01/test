


|**Название**|**Вес**|
| :- | :- |
|<p>Как настроить Google OAuth[^1]</p>|10|


**Настройка G Suite для OAuth с помощью Rancher**

[1.   Добавление Rancher в качестве авторизованного домена](https://github.com/markizz01/test/blob/main/ru/google/%D0%9A%D0%B0%D0%BA%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B8%D1%82%D1%8C%20Google%20OAuth.md#1---%D0%B4%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-rancher-%D0%B2-%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B5-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%B0)	

[2.   Создание учетных данных OAuth2 для сервера Rancher](https://github.com/markizz01/test/blob/main/ru/google/%D0%9A%D0%B0%D0%BA%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B8%D1%82%D1%8C%20Google%20OAuth.md#2---%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D1%83%D1%87%D0%B5%D1%82%D0%BD%D1%8B%D1%85-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-oauth2-%D0%B4%D0%BB%D1%8F-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-rancher)

[3.   Создание учетных данных учетной записи сервиса](https://github.com/markizz01/test/blob/main/ru/google/%D0%9A%D0%B0%D0%BA%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B8%D1%82%D1%8C%20Google%20OAuth.md#3---%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D1%83%D1%87%D0%B5%D1%82%D0%BD%D1%8B%D1%85-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-%D1%83%D1%87%D0%B5%D1%82%D0%BD%D0%BE%D0%B9-%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0)	

[4.   Зарегистрируйте ключ учетной записи сервиса в качестве клиента OAuth](https://github.com/markizz01/test/blob/main/ru/google/%D0%9A%D0%B0%D0%BA%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B8%D1%82%D1%8C%20Google%20OAuth.md#4---%D0%B7%D0%B0%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D1%83%D0%B9%D1%82%D0%B5-%D0%BA%D0%BB%D1%8E%D1%87-%D1%83%D1%87%D0%B5%D1%82%D0%BD%D0%BE%D0%B9-%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0-%D0%B2-%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B5-%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D0%B0-oauth)

**Настройка Google OAuth в Rancher**

   Если ваша организация использует G Suite для аутентификации пользователей, вы можете настроить Rancher так, чтобы ваши пользователи могли входить в систему, используя свои учетные данные G Suite.

   Только администраторы домена G Suite имеют доступ к Admin SDK. Таким образом, только администраторы G Suite могут настроить Google OAuth для Rancher.

   В Rancher только администраторы или пользователи с глобальной ролью **Manage Authentication** (управление аутентификацией) могут настраивать аутентификацию.
   
# Предварительные требования
- У вас должна быть настроена [учетная запись администратора G Suite](https://admin.google.com/). 
- Для G Suite требуется [верхний частный домен FQDN](https://github.com/google/guava/wiki/InternetDomainNameExplained#public-suffixes-and-private-domains) в качестве авторизованного домена. Один из способов получить FQDN — создать A-запись в Route53 для вашего сервера Rancher. Вам не нужно обновлять настройки URL-адреса вашего сервера Rancher с помощью этой записи, поскольку могут существовать кластеры, использующие этот URL-адрес.
- У вас должно быть включено API Admin SDK для вашего домена G Suite. Вы можете включить его, выполнив действия на [этой странице](https://support.google.com/a/answer/60757?hl=en).

   После того, как API Admin SDK будет включено, экран API вашего домена G Suite должен выглядеть следующим образом: 

![скриншот](https://user-images.githubusercontent.com/22409457/207041892-17ee4359-11af-4065-a5b4-dad47302154b.png)

# Настройка G Suite для OAuth с помощью Rancher
   Прежде чем вы сможете настроить Google OAuth в Rancher, вам необходимо войти в свою учетную запись G Suite и выполнить следующее:

1. [Добавление Rancher в качестве авторизованного домена](https://github.com/markizz01/test/blob/main/ru/google/%D0%9A%D0%B0%D0%BA%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B8%D1%82%D1%8C%20Google%20OAuth.md#1-%D0%B4%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-rancher-%D0%B2-%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B5-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%B8%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%B0),
2. [Создание учетных данных OAuth2 для сервера Rancher](https://github.com/markizz01/test/blob/main/ru/google/%D0%9A%D0%B0%D0%BA%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B8%D1%82%D1%8C%20Google%20OAuth.md#2-%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D1%83%D1%87%D0%B5%D1%82%D0%BD%D1%8B%D1%85-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-oauth2-%D0%B4%D0%BB%D1%8F-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-rancher),
3. [Создание учетных данных учетной записи сервиса](https://github.com/markizz01/test/blob/main/ru/google/%D0%9A%D0%B0%D0%BA%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B8%D1%82%D1%8C%20Google%20OAuth.md#3-%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D1%83%D1%87%D0%B5%D1%82%D0%BD%D1%8B%D1%85-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-%D1%83%D1%87%D0%B5%D1%82%D0%BD%D0%BE%D0%B9-%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0),
4. [Зарегистрируйте ключ учетной записи сервиса в качестве клиента OAuth](https://github.com/markizz01/test/blob/main/ru/google/%D0%9A%D0%B0%D0%BA%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B8%D1%82%D1%8C%20Google%20OAuth.md#4---%D0%B7%D0%B0%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D1%83%D0%B9%D1%82%D0%B5-%D0%BA%D0%BB%D1%8E%D1%87-%D1%83%D1%87%D0%B5%D1%82%D0%BD%D0%BE%D0%B9-%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0-%D0%B2-%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B5-%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D0%B0-oauth).
 
## 1. Добавление Rancher в качестве авторизованного домена
1. Нажмите [здесь](https://console.developers.google.com/apis/credentials), чтобы перейти на страницу учетных данных вашего домена Google.
2. Выберите свой проект и нажмите **OAuth consent screen** (экран согласования OAuth).

![скриншот 1](Aspose.Words.7ae75f5e-a5f7-4975-a8c7-98e9b15cf48b.002.png)

3. Перейдите в раздел **Authorized Domains** (авторизованные домены) и введите в списке URL-адрес верхнего частного домена (top private domain) вашего сервера Rancher. Верхний частный домен (top private domain) — это самый правый супердомен. Так, например, foo.co.uk — верхний частный домен для [www.foo.co.uk](http://www.foo.co.uk). Для получения дополнительной информации о доменах верхнего уровня обратитесь к [этой статье](https://github.com/google/guava/wiki/InternetDomainNameExplained#public-suffixes-and-private-domains).
4. Перейдите в **Scopes for Google APIs** (области для API Google) и убедитесь, что **email** (электронная почта), **profile** (профиль) и **openid** включены.

**Результат:** Rancher был добавлен в качестве авторизованного домена для API Admin SDK.

## 2. Создание учетных данных OAuth2 для сервера Rancher
1. Перейдите в консоль Google API, выберите свой проект и перейдите на страницу учетных данных.

![](Aspose.Words.7ae75f5e-a5f7-4975-a8c7-98e9b15cf48b.003.png)

2. В раскрывающемся списке **Create Credentials** (создать учетные данные) выберите **OAuth client ID** (идентификатор клиента OAuth).
3. Выберите **Web application** (веб-приложение).
4. Укажите имя.
5. Заполните **Authorized JavaScript origins** (авторизованные origin JavaScript) и **Authorized redirect URIs** (авторизованные URI перенаправления).
*Примечание: Страница пользовательского интерфейса Rancher для настройки Google OAuth предоставляет вам точные ссылки для ввода на этом шаге. Эта страница доступна в Global view в разделе **Security** > **Authentication** > **Google** (Безопасность > Аутентификация > Google).*

- В блоке **Authorized JavaScript origins** (авторизованные origin JavaScript) введите URL-адрес вашего сервера Rancher.
- В блоке **Authorized redirect URIs** (авторизованные URI перенаправления) введите URL-адрес вашего сервера Rancher с добавлением пути verify-auth. Например, если ваш URI равен https://rancherServer, вы войдете в [https://](https://rancherserver/verify-auth)[rancherServer](https://rancherserver/verify-auth)[/verify-auth](https://rancherserver/verify-auth).
6. Нажмите **Create** (создать).
7. После создания учетных данных вы увидите экран со списком ваших учетных данных. Выберите учетные данные, которые вы только что создали, и в этой строке в крайнем правом углу нажмите **Download JSON** (загрузить JSON). Сохраните файл, чтобы вы могли предоставить Rancher эти учетные данные.

**Результат:** Ваши учетные данные OAuth были успешно созданы.

## 3. Создание учетных данных учетной записи сервиса
   Поскольку Google Admin SDK доступен только администраторам, обычные пользователи не могут использовать его для получения профилей других пользователей или их групп. Обычные пользователи не могут даже получить доступ к своим собственным группам.

   Поскольку Rancher предоставляет *доступ к членству на основе групп*, нам нужно, чтобы пользователи могли создавать свои собственные группы и при необходимости искать других пользователей и группы.

   В качестве обходного пути для получения этой возможности G Suite рекомендует создать учетную запись сервиса и делегировать полномочия вашего домена G Suite этой учетной записи сервиса.

   В этом разделе описывается, как:

- создать учетную запись сервиса,
- создать ключ для учетной записи сервиса и загрузить учетные данные в формате JSON.

1. Нажмите [здесь](https://console.developers.google.com/iam-admin/serviceaccounts) и выберите свой проект, для которого вы сгенерировали учетные данные OAuth.
2. Нажмите **Create Service Account** (создать учетную запись сервиса).
3. Введите имя и нажмите **Create** (создать).

![скриншот 2](Aspose.Words.7ae75f5e-a5f7-4975-a8c7-98e9b15cf48b.004.png)

4. Не указывайте никаких ролей на странице **Service account permissions** (разрешения учетной записи сервиса) и нажмите **Continue** (продолжить).

![скриншот 3](Aspose.Words.7ae75f5e-a5f7-4975-a8c7-98e9b15cf48b.005.png)

5. Нажмите на **Create Key** (создать ключ) и выберите параметр JSON. Загрузите JSON-файл и сохраните его, чтобы вы могли предоставить его в качестве учетных данных аккаунта сервиса для Rancher.

![скриншот 4](Aspose.Words.7ae75f5e-a5f7-4975-a8c7-98e9b15cf48b.006.png)

**Результат:** Ваша учетная запись для сервиса создана.

## 4.   Зарегистрируйте ключ учетной записи сервиса в качестве клиента OAuth
   Вам нужно будет предоставить некоторые разрешения (permission) созданной на последнем шаге учетной записи сервиса. Rancher требует, чтобы вы предоставляли пользователям и группам разрешения только на чтение.

   Используя уникальный идентификатор ключа учетной записи сервиса (Unique ID), зарегистрируйте его в качестве клиента Oauth, выполнив следующие действия:

1. Получите уникальный идентификатор ключа, который вы только что создали. Если он не отображается в списке ключей рядом с тем, который вы создали, вам придется включить его. Чтобы включить его, нажмите **Unique ID** (уникальный идентификатор) и нажмите **OK**. Это добавит столбец **Unique ID** в список ключей учетной записи сервиса. Сохраните тот, который указан для созданной вами учетной записи сервиса. 

*Примечание: это цифровой ключ, который не следует путать с буквенно-цифровым полем **Key ID** (идентификатор ключа).*

![скриншот 6](Aspose.Words.7ae75f5e-a5f7-4975-a8c7-98e9b15cf48b.007.png)

2. Перейдите на страницу [**Domain-wide Delegation**](https://admin.google.com/ac/owl/domainwidedelegation) (делегирование по всему домену).
3. Добавьте уникальный идентификатор, полученный на предыдущем шаге, в поле **Client Name** (имя клиента).
4. В поле **One or More API Scopes** (одна или несколько областей API) добавьте следующие области:
openid,profile,email,https://www.googleapis.com/auth/admin.directory.user.readonly,https://www.googleapis.com/auth/admin.directory.group.readonly

5. Нажмите **Authorize** (авторизоваться).

**Результат:** Учетная запись сервиса зарегистрирована как клиент OAuth в вашей учетной записи G Suite.

# Настройка Google OAuth в Rancher
1. Войдите в Rancher, используя локального пользователя, которому назначена роль администратора. Этот пользователь также называется локальным принципалом (local principal).
1. В левом верхнем углу нажмите **☰> Users & Authentication** (пользователи и аутентификация).
2. В левом навигационном меню выберите **Auth Provider** (поставщик аутентификации).
3. Нажмите **Google**. Инструкции в пользовательском интерфейсе описывают шаги по настройке аутентификации с помощью Google OAuth.
   a. ***Admin Email***: Укажите адрес электронной почты учетной записи администратора из вашей установки GSuite. Для выполнения поиска пользователей и групп, API Google требуют адрес электронной почты администратора в сочетании с ключом учетной записи сервиса.
   b. ***Domain***: Укажите домен, на котором вы настроили GSuite. Укажите точный домен, а не какие-либо псевдонимы.
   c. ***Nested Group Membership***: установите этот флаг, чтобы включить членство во вложенных группах. Администраторы Rancher могут отключить это в любое время после настройки авторизации.
      - Первый шаг заключается в добавлении Rancher в качестве авторизованного домена, о котором мы уже рассказывали в [этом разделе](#_9vyep7j2w3hp).
      - Для второго шага укажите учетные данные OAuth в формате JSON, которые вы загрузили после завершения [этого раздела](#_hv4a7jp5d5js). Вы можете загрузить файл или вставить его содержимое в поле **OAuth Credentials** (учетные данные OAuth).
      - Для третьего шага укажите в формате JSON учетные данные для аккаунта сервиса, загруженные в конце [этого раздела](#_sfovz4u8wxkj). Учетные данные будут работать только в том случае, если вы успешно зарегистрировали [ключ учетной записи сервиса](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/admin-settings/authentication/google/_index.md#4-register-the-service-account-key-as-an-oauth-client) в качестве клиента OAuth в своей учетной записи G Suite. 
4. Нажмите **Authenticate with Google** (Аутентификация с помощью Google).
5. Нажмите **Enable** (включить).

**Результат:** аутентификация Google успешно настроена.



[^1]: [Configuring Google OAuth](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/admin-settings/authentication/google/_index.md)
