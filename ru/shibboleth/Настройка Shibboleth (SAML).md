


|**Название**|**Вес**|
| :- | :- |
|<p>Настройка Shibboleth (SAML)[^1]</p>|1210|


1.  [**Настройка Shibboleth в Rancher**](https://github.com/markizz01/test/blob/main/ru/shibboleth/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20Shibboleth%20(SAML).md#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-shibboleth-%D0%B2-rancher)
  + [Предварительные требования для Shibboleth](https://github.com/markizz01/test/blob/main/ru/shibboleth/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20Shibboleth%20(SAML).md#%D0%BF%D1%80%D0%B5%D0%B4%D0%B2%D0%B0%D1%80%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%B4%D0%BB%D1%8F-shibboleth)
  + [Настройте Shibboleth в Rancher](https://github.com/markizz01/test/blob/main/ru/shibboleth/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20Shibboleth%20(SAML).md#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%82%D0%B5-shibboleth-%D0%B2-rancher)
  + [Предостережения поставщика SAML](https://github.com/markizz01/test/blob/main/ru/shibboleth/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20Shibboleth%20(SAML).md#%D0%BF%D1%80%D0%B5%D0%B4%D0%BE%D1%81%D1%82%D0%B5%D1%80%D0%B5%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BF%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D1%89%D0%B8%D0%BA%D0%B0-saml)
2.  [**Настройка OpenLDAP в Rancher**](https://github.com/markizz01/test/blob/main/ru/shibboleth/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20Shibboleth%20(SAML).md#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-openldap-%D0%B2-rancher)
  + [Предварительные требования для OpenLDAP](https://github.com/markizz01/test/blob/main/ru/shibboleth/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20Shibboleth%20(SAML).md#%D0%BF%D1%80%D0%B5%D0%B4%D0%B2%D0%B0%D1%80%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%B4%D0%BB%D1%8F-openldap)
  + [Настройка OpenLDAP в Rancher](https://github.com/markizz01/test/blob/main/ru/shibboleth/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20Shibboleth%20(SAML).md#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-openldap-%D0%B2-rancher-1)
3.  [**Устранение неполадок**](https://github.com/markizz01/test/blob/main/ru/shibboleth/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20Shibboleth%20(SAML).md#%D1%83%D1%81%D1%82%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BD%D0%B5%D0%BF%D0%BE%D0%BB%D0%B0%D0%B4%D0%BE%D0%BA)

  Если ваша организация использует Shibboleth Identity Provider (IdP) для аутентификации пользователей, вы можете настроить Rancher так, чтобы ваши пользователи могли входить в Rancher, используя свои учетные данные Shibboleth.

  В таком случае при входе пользователей Rancher в систему будет выполнено перенаправление на Shibboleth IdP для ввода учетных данных пользователей. После аутентификации пользователи будут перенаправлены обратно в пользовательский интерфейс Rancher.

  Если вы также настроите OpenLDAP в качестве бэкенда для Shibboleth, он вернет Rancher утверждение SAML (SAML assertion) с атрибутами пользователя, которые включают группы. Затем аутентифицированный пользователь сможет получить доступ к ресурсам в Rancher, на которые у его групп есть разрешения.

*Инструкции в этом разделе предполагают, что вы понимаете, как Rancher, Shibboleth и OpenLDAP работают вместе. Для более подробной информации обратитесь к этой странице.*

# Настройка Shibboleth в Rancher

## Предварительные требования для Shibboleth
- *У вас должен быть настроен сервер Shibboleth IdP.*
- *Необходимо настроить ниже приведенные URL-адреса поставщика услуг Rancher (Rancher Service Provider):*
  - *URL метаданных: https://<rancher-server>/v1-saml/shibboleth/saml/metadata* 
  - *Assertion Consumer Service (ACS) URL: https://<rancher-server>/v1-saml/shibboleth/saml/acs* 
- *Необходимо экспортировать файл metadata.xml с вашего сервера IdP. Для получения дополнительной информации см.[ ](https://documentation.pingidentity.com/pingfederate/pf83/index.shtml#concept_exportingMetadata.html)[документацию по Shibboleth](https://wiki.shibboleth.net/confluence/display/SP3/Home).*
  
## Настройте Shibboleth в Rancher
  Если ваша организация использует Shibboleth для аутентификации пользователей, вы можете настроить Rancher так, чтобы ваши пользователи могли входить в систему, используя свои учетные данные IdP.

1. В левом верхнем углу нажмите **☰> Users & Authentication** (пользователи и аутентификация).
2. В левом навигационном меню выберите **Auth Provider** (поставщик аутентификации).
3. Нажмите **Shibboleth**.
4. Заполните форму **Configure Shibboleth Account** (настройки учетной записи Shibboleth). Shibboleth IdP позволяет вам указать, какое хранилище данных вы хотите использовать. Вы можете либо добавить базу данных, либо использовать существующий ldap-сервер. Если вы выберете сервер Active Directory (AD), ознакомьтесь с приведенными ниже примерами, чтобы узнать, как сопоставить атрибуты AD с полями в Rancher.
    1. **Display Name Field**: Введите атрибут AD, содержащий отображаемые имена пользователей (пример: displayName).
    2. **User Name Field**: Введите атрибут AD, содержащий имя пользователя/заданное имя (given name). Например, givenName.
    3. **UID Field**: Введите атрибут AD, уникальный для каждого пользователя (пример: sAMAccountName, distinguishedName).
    4. **Groups Field**: Вносит записи для управления членством в группах (пример: memberOf).
    5. **Rancher API Host**: Введите URL-адрес вашего сервера Rancher.
    6. **Private Key and Certificate**: Пара ключ-сертификат для создания защищенной оболочки (secure shell) между Rancher и вашим IdP.
  Вы можете сгенерировать ее с помощью команды openssl. Например:
  openssl req -x509 -newkey rsa:2048 -keyout myservice.key -out myservice.cert -days 365 -nodes -subj "/CN=myservice.example.com"
    7. **IDP-metadata**: Файл metadata.xml, который вы экспортировали с вашего сервера IdP.
5. После заполнения формы **Configure Shibboleth Account** нажмите **Enable** (включить).

Rancher перенаправит вас на страницу входа в систему IdP. Чтобы провалидировать вашу конфигурацию Rancher Shibboleth, введите учетные данные, необходимые для аутентификации с помощью Shibboleth IdP.

* **Примечание:** Возможно, вам придется отключить блокировщик всплывающих окон, чтобы увидеть страницу входа в IdP.*

**Результат:** Rancher настроен для работы с Shibboleth. Теперь ваши пользователи могут входить в Rancher, используя свои логины из Shibboleth.
  
## Предостережения поставщика SAML
  Если вы настраиваете Shibboleth без OpenLDAP, обратите внимание на следующие предостережения, связанные с тем, что протокол SAML не поддерживает поиск (search) или просмотр (lookup) для пользователей или групп.

- Не выполняется валидация пользователей или групп при назначении им разрешений в Rancher.
- При добавлении пользователей точные идентификаторы пользователей (т.е. поле UID) должны быть введены правильно. Когда вы вводите идентификатор пользователя, не производится поиск других идентификаторов пользователей, которые могут совпадать с набранным вами.
- При добавлении групп вы должны выбрать группу из выпадающего списка, который находится рядом с текстовым полем. Rancher предполагает, что все, что было введено в текстовом поле, является пользователем.
- В раскрывающемся списке групп отображаются только те группы, членом которых вы являетесь. Вы не сможете добавлять группы, членом которых вы не являетесь.

Чтобы включить поиск групп при назначении разрешений в Rancher, будет необходимо настроить бэкенд для поставщика SAML, поддерживающего группы, например, для OpenLDAP.
  
# Настройка OpenLDAP в Rancher
  Если вы также настроите OpenLDAP в качестве бэкенда для Shibboleth, он вернет Rancher утверждение SAML (SAML assertion) с атрибутами пользователя, включающими группы. Затем аутентифицированные пользователи смогут получить доступ к ресурсам в Rancher, на которые у их групп есть разрешения.
  
## Предварительные требования для OpenLDAP
Rancher должен быть настроен с учетной записью LDAP для подключения  (LDAP bind account), то есть учетной записью сервиса. Это необходимо, чтобы можно было выполнять поиск и извлечение записей LDAP, относящихся к пользователям и группам, которые должны иметь доступ. Для этой цели рекомендуется не использовать учетную запись администратора или личную учетную запись, а вместо этого создать специальную учетную запись в OpenLDAP с доступом только на чтение пользователей и групп в настроенной базе поиска (см. ниже).

* **Использование TLS?** *

*Если сертификат, используемый сервером OpenLDAP, является самоподписанным (self-signed) или получен не от общепризнанного центра сертификации, убедитесь, что у вас под рукой есть сертификат CA (объединенный с любыми промежуточными сертификатами) в формате PEM. Вам нужно будет вставить этот сертификат во время настройки, чтобы Rancher мог проверить цепочку сертификатов.*

## Настройка OpenLDAP в Rancher
  Настройте параметры для сервера OpenLDAP, групп и пользователей. Для получения информации о заполнении каждого поля обратитесь к справке по конфигурированию. Обратите внимание, что членство во вложенных группах недоступно для Shibboleth.

*Прежде чем приступить к настройке, пожалуйста, ознакомьтесь с концепциями  из раздела "Внешняя настройка аутентификации и пользователи-принципалы (principal user)".*

1. Войдите в пользовательский интерфейс Rancher, используя первоначальную локальную учетную запись admin.
2. В левом верхнем углу нажмите **☰> Users & Authentication** (пользователи и аутентификация).
3. В левом навигационном меню выберите **Auth Provider** (поставщик аутентификации).
4. Нажмите **OpenLDAP**. Появится форма **Configure an OpenLDAP server** (настройка сервера OpenLDAP). 
  
# Устранение неполадок
  Если у вас возникли проблемы при тестировании подключения к серверу OpenLDAP, сначала дважды проверьте учетные данные, введенные для учетной записи сервиса, а также конфигурацию базы поиска. Вы также можете просмотреть журналы Rancher, чтобы более точно определить причину проблемы. Журналы отладки (debug log) могут также содержать более подробную информацию об ошибке. Пожалуйста, обратитесь к разделу "Как я могу включить ведение журнала отладки" в этой документации.


[^1]: [Configuring Shibboleth (SAML)](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/admin-settings/authentication/shibboleth/_index.md)
