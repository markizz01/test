


|**Название**|**Вес**|
| :- | :- |
|<p>[Configuring Active Directory (AD)](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/admin-settings/authentication/ad/_index.md) </p><p>Как настроить Active Directory (AD)[^1]</p>|1112|


# [Предварительные требования](#_czw5ehs795m4)	                     

## [Этапы настройки](#_utqdzehtseg9)	                                 

[Откройте конфигурацию Active Directory](https://github.com/markizz01/test/blob/main/ru/ad/%D0%9A%D0%B0%D0%BA%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B8%D1%82%D1%8C%20Active%20Directory%20(AD).md#%D0%BE%D1%82%D0%BA%D1%80%D0%BE%D0%B9%D1%82%D0%B5-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D1%8E-active-directory)	

[Установите параметры сервера Active Directory](https://github.com/markizz01/test/blob/main/ru/ad/%D0%9A%D0%B0%D0%BA%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B8%D1%82%D1%8C%20Active%20Directory%20(AD).md#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D0%B5-%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D1%8B-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-active-directory)

[Настройте схему пользователя/группы](https://github.com/markizz01/test/blob/main/ru/ad/%D0%9A%D0%B0%D0%BA%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B8%D1%82%D1%8C%20Active%20Directory%20(AD).md#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%82%D0%B5-%D1%81%D1%85%D0%B5%D0%BC%D1%83-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D1%8B)

[Схема пользователя](https://github.com/markizz01/test/blob/main/ru/ad/Как%20настроить%20Active%20Directory%20(AD).md#схема-группы)

[Схема группы](#_vskz62qp2i6j)	

[Протестируйте аутентификацию](#_vdcoq4sskbwz)	

## [Приложение: Определите базу поиска и схему с помощью ldapsearch](#_42euqsj1tqyf)	

[Определите базу поиска (Search Base)](#_rjvthtfmgqv)	

[Определите схему пользователя](#_idto11129j8p)	

[Определите схему группы](#_7s082lbmkxxf)	

## [Приложение: Устранение неполадок](#_bi5mjlbexmbu)	


Если ваша организация использует Microsoft Active Directory (AD) в качестве центрального хранилища пользователей, вы можете настроить Rancher так, чтобы он взаимодействовал с сервером Active Directory для аутентификации пользователей. Это позволяет администраторам Rancher контролировать доступ к кластерам и проектам. Для этого используются пользователи и группы, управление которыми происходит извне в Active Directory. При этом конечные пользователи смогут проходить аутентификацию с использованием своих учетных данных AD при входе в пользовательский интерфейс Rancher. 

Rancher использует LDAP для связи с сервером Active Directory. Таким образом, процесс аутентификации с помощью Active Directory аналогичен процессу аутентификации с помощью OpenLDAP.

***Примечание:** Перед началом работы, пожалуйста, ознакомьтесь с разделом "Внешняя настройка аутентификации и пользователи-принципалы (principal user)".*

# Предварительные требования
Вам нужно будет создать (или получить от вашего администратора AD) нового AD-пользователя для использования в качестве учетной записи сервиса Rancher. Этот пользователь должен иметь достаточные разрешения (permission) для выполнения LDAP-поиска и для чтения атрибутов пользователей и групп в вашем домене AD.

Обычно для этой цели следует использовать учетную запись **пользователя домена (Domain User)**, не являющегося администратором, поскольку по умолчанию такой пользователь имеет права только на чтение для большинства объектов в разделе домена.

Обратите внимание, что в некоторых заблокированных конфигурациях Active Directory это поведение по умолчанию может не применяться. В таком случае вам нужно будет убедиться, что пользователь учетной записи сервиса имеет, по крайней мере, разрешения (permission) на чтение и на перечисление содержимого, предоставленные либо глобально для домена, либо в базовом организационном подразделении (Base OU), включающем пользователей и группы.

***Использование TLS?***

- *Если сертификат, используемый сервером AD, является самоподписанным (self-signed) или получен не от общепризнанного центра сертификации, убедитесь, что у вас под рукой есть сертификат CA (объединенный с любыми промежуточными сертификатами) в формате PEM. Вам нужно будет вставить этот сертификат во время настройки, чтобы Rancher мог проверить цепочку сертификатов.*
- *После обновления до версии v2.6.0 аутентификация через Rancher с помощью Active Directory с использованием TLS может завершиться неудачей, если сертификаты на сервере AD не поддерживают атрибуты SAN. Эта проверка по умолчанию включена в Go v1.15.* 
  - *Получена ошибка "Error creating SSL connection: LDAP Result Code 200 "Network Error": x509: certificate relies on legacy Common Name field, use SANs or temporarily enable Common Name matching with GODEBUG=x509ignoreCN=0"[^2].*
  - *Чтобы устранить ошибку, обновите или замените сертификаты на сервере AD новыми, поддерживающими атрибут SAN. В качестве альтернативы, эту ошибку можно проигнорировать, установив GODEBUG=x509ignoreCN=0 в качестве переменной среды для контейнера сервера Rancher.*
# Этапы настройки
## Откройте конфигурацию Active Directory
1. Войдите в пользовательский интерфейс Rancher, используя первоначальную локальную учетную запись admin.
1. В левом верхнем углу нажмите **☰>** **Users & Authentication (**пользователи и аутентификация). 
1. В левом навигационном меню нажмите **Auth Provider** (поставщик аутентификации).
1. Нажмите **ActiveDirectory**. Будет отображена форма **Authentication Provider: ActiveDirectory**.
1. Заполните форму. Для получения справки обратитесь к подробной информации о параметрах конфигурации (см. ниже).
1. Нажмите **Enable** (включить).
#
## Установите параметры сервера Active Directory
В разделе 1. Configure an Active Directory server (настройка сервера Active Directory), заполните поля информацией, относящейся к вашему серверу Active Directory. Пожалуйста, обратитесь к нижеуказанной таблице  для получения подробной информации о требуемых значениях для каждого параметра.

***Примечание:** Если вы не уверены, какие значения вводить в поле база поиска (Search Base) пользователя/группы, пожалуйста, обратитесь к разделу [Приложение: Определите базу поиска и схему с помощью ldapsearch](#_42euqsj1tqyf).*

Таблица 1: Параметры сервера AD

|**Параметр**|**Описание**|
| :-: | :- |
|Hostname|Укажите название хоста или IP-адрес сервера AD.|
|Port|Укажите порт, на котором сервер Active Directory прослушивает соединения. Незашифрованный LDAP обычно использует стандартный порт 389, а LDAPS использует порт 636.|
|TLS|Установите этот флаг, чтобы включить LDAP через SSL/TLS (обычно известный как LDAPS).|
|Server Connection Timeout|Продолжительность в секундах, которую Rancher ожидает, прежде чем начать считать сервер AD недоступным.|
|Service Account Username|Введите имя пользователя учетной записи AD с доступом только для чтения к разделу вашего домена (см. [Предварительные требования](#_czw5ehs795m4)). Имя пользователя может быть введено в формате NetBIOS (например, "DOMAIN\serviceaccount") или формате UPN (например, "serviceaccount@domain.com").|
|Service Account Password|Пароль для учетной записи сервиса.|
|Default Login Domain|Если вы настроите это поле с именем NetBIOS вашего домена AD, имена пользователей, введенные без домена (например, "jdoe"), будут автоматически преобразованы в сокращенный логин NetBIOS (например, "LOGIN\_DOMAIN\jdoe") при привязке к серверу AD. Если ваши пользователи проходят аутентификацию с помощью UPN в качестве имени пользователя (например, "jdoe@acme.com"), то это поле **должно быть** оставлено пустым.|
|User Search Base|Уникальное имя (Distinguished Name, DN) узла в вашем дереве директорий, с которого следует начинать поиск объектов пользователя. Все пользователи должны быть потомками этого базового DN. Например: "ou=people,dc=acme, dc=com".|
|Group Search Base|Если ваши группы находятся под другим узлом, чем тот, который настроен в базе поиска пользователя (User Search Base), вам нужно будет указать здесь уникальное имя (Distinguished Name, DN). В противном случае оставьте его пустым. Например: "ou=groups,dc=acme,dc=com".|
## Настройте схему пользователя/группы
В разделе 2. Customize Schema (настройка схемы), вы должны предоставить Rancher правильное сопоставление (mapping) атрибутов пользователя и группы, соответствующих схеме, используемой в вашей директории.

Rancher использует LDAP-запросы для поиска и извлечения информации о пользователях и группах в Active Directory. Сопоставления атрибутов, настроенные в этом разделе, используются для построения фильтров поиска и урегулирования членства в группах. Поэтому крайне важно, чтобы предоставленные настройки отражали реальность вашего AD.

***Примечание:** Если вы не знакомы со схемой, используемой в вашем домене Active Directory, пожалуйста, обратитесь к разделу документации [Приложение: Определите базу поиска и схему с помощью ldapsearch](#_42euqsj1tqyf), чтобы определить правильные значения конфигурации.*

### Схема пользователя
   В таблице ниже подробно описаны параметры для настройки раздела, описывающего схему пользователя.

Таблица 2: Параметры конфигурации схемы пользователя

|**Параметр**|**Описание**|
| :-: | :- |
|Object Class|Название класса объекта, используемое для объектов пользователя в вашем домене. Если определено, укажите только название класса объекта — не включайте его в обертку LDAP (LDAP wrapper), такую как &(objectClass=xxxx)|
|Username Attribute|Атрибут пользователя, значение которого подходит в качестве отображаемого имени.|
|Login Attribute|Атрибут, значение которого соответствует части имени пользователя, которое было введено при входе в Rancher. Если ваши пользователи проходят аутентификацию с помощью своего UPN в качестве имени пользователя (например, "jdoe@acme.com"), то в этом поле обычно должно быть установлено значение userPrincipalName. В противном случае для прежних, в стиле NetBIOS, имен входа в систему (например, "jdoe") обычно используется sAMAccountName.|
|User Member Attribute|Атрибут, содержащий группы, членом которых является пользователь.|
|Search Attribute|Когда пользователь вводит текст для добавления пользователей или групп в пользовательский интерфейс, Rancher отправляет запрос серверу AD и пытается найти пользователей с помощью атрибутов, указанных в этом параметре. Можно указать несколько атрибутов, разделив их символом канала ("|"). Обычно для сопоставления имен UPN-пользователей (например, jdoe@acme.com) вы должны установить значение этого поля равным userPrincipalName.|
|Search Filter|<p>Этот фильтр применяется к списку пользователей, по которому выполняется поиск, когда Rancher пытается добавить пользователей в список доступа к сайту (site access list) или пытается добавить участников в кластеры или проекты. Например, фильтр поиска пользователя может выглядеть как (|(memberOf=CN=group1,CN=Users,DC=testad,DC=rancher,DC=io)(memberOf=CN=group2,CN=Users,DC=testad,DC=rancher,DC=io)). </p><p>***Примечание:** Если фильтр поиска не использует [допустимый AD синтаксис поиска](https://docs.microsoft.com/en-us/windows/win32/adsi/search-filter-syntax), список пользователей будет пустым.*</p>|
|User Enabled Attribute|Атрибут, содержащий целое значение, представляющее побитовое перечисление флагов учетной записи пользователя. Rancher использует его, чтобы определить, отключена ли учетная запись пользователя. Обычно вы должны оставить его равным стандартному для AD userAccountControl.|
|Disabled Status Bitmask|Это значение User Enabled Attribute, обозначающее отключенную учетную запись пользователя. Обычно вы должны оставить для этого параметра значение по умолчанию "2", как указано в схеме Microsoft Active Directory (см. [здесь](https://docs.microsoft.com/en-us/windows/desktop/adschema/a-useraccountcontrol#remarks)).|
### Схема группы
 В таблице ниже подробно описаны параметры для настройки схемы группы.

Таблица 3: Параметры конфигурации схемы группы

|**Параметр**|**Описание**|
| :-: | :- |
|Object Class|Название класса объектов, используемое для группировки объектов в вашем домене. Если определено, укажите только название класса объекта — не включайте его в обертку LDAP (LDAP wrapper), такую как &(objectClass=xxxx)|
|Name Attribute|Атрибут группы, значение которого подходит для отображаемого имени.|
|Group Member User Attribute|Название **атрибута пользователя**, формат которого соответствует членам группы в Group Member Mapping Attribute.|
|Group Member Mapping Attribute|Название атрибута группы, содержащего членов группы.|
|Search Attribute|Атрибут, используемый для построения фильтров поиска при добавлении групп в кластеры или проекты. Смотрите описание в схеме пользователя (Search Attribute).|
|Search Filter|<p>Этот фильтр применяется к списку групп, по которым выполняется поиск, когда Rancher пытается добавить группы в список доступа к сайту (site access list) или пытается добавить группы в кластеры или проекты. Например, фильтр поиска группы может выглядеть как (|(cn=group1)(cn=group2)). </p><p>*Примечание: Если фильтр поиска не использует [допустимый AD синтаксис поиска](https://docs.microsoft.com/en-us/windows/win32/adsi/search-filter-syntax), список групп будет пустым.*</p>|
|Group DN Attribute|Название атрибута группы, формат которого соответствует значениям в атрибуте пользователя, описывающем членство пользователя. См. User Member Attribute.|
|Nested Group Membership|Эти параметры определяют, должен ли Rancher разрешать вложенное членство групп. Используйте только в том случае, если ваша организация использует эти вложенные членства (nested memberships), т.е., если у вас есть группы, которые содержат другие группы в качестве членов. Мы рекомендуем по возможности избегать вложенных групп, чтобы избежать потенциальных проблем с производительностью при большом количестве вложенных членств.|
## Протестируйте аутентификацию
После завершения настройки протестируйте подключение к серверу AD, **используя свою учетную запись администратора AD**. Если тест пройдет успешно, аутентификация с помощью настроенного Active Directory будет включена неявным образом. При этом для нее будет использоваться учетная запись, которую вы использовали при тестировании с настройкой в качестве администратора.

***Примечание:** Пользователь AD, имеющий учетные данные, введенные на этом шаге, будет сопоставлен с учетной записью локального принципала и ему будут присвоены привилегии администратора в Rancher. Поэтому вы должны принять сознательное решение о том, какой учетную запись AD вы используете для выполнения этого шага.*



1. Введите **username** (имя пользователя**)** и **password** (пароль**)** для учетной записи AD, которые должны быть сопоставлены с учетной записью локального принципала.
1. Нажмите **Authenticate with Active Directory** (пройти аутентификацию с помощью Active Directory), чтобы завершить установку.

**Результат:**

- Включена аутентификация Active Directory.
- Вы вошли в Rancher как администратор, используя предоставленные учетные данные AD.

***Примечание:** Вы по-прежнему сможете войти в систему, используя локально настроенную учетную запись admin и пароль в случае сбоя в работе сервисов LDAP.*

# Приложение: Определите базу поиска и схему с помощью ldapsearch
  Для успешной настройки аутентификации AD крайне важно, чтобы вы предоставили правильную конфигурацию, относящуюся к иерархии и схеме вашего сервера AD.

   Инструмент [ldapsearch](http://manpages.ubuntu.com/manpages/artful/man1/ldapsearch.1.html) позволяет вам отправить запрос на ваш сервер AD, чтобы узнать о схеме, используемой для объектов пользователей и групп.

  Для демонстрации на примере предположим, что

- имя хоста сервера Active Directory — ad.acme.com,
- сервер прослушивает незашифрованные соединения на порту 389,
- домен Active Directory — acme,
- у вас есть существующий аккаунт AD с именем пользователя jdoe и паролем secret.
## Определите базу поиска (Search Base)
   Сначала мы будем использовать ldapsearch для определения уникального имени (Distinguished Name, DN) родительского узла (родительских узлов) для пользователей и групп:

$ ldapsearch -x -D "acme\jdoe" -w "secret" -p 389 \

-h ad.acme.com -b "dc=acme,dc=com" -s sub "sAMAccountName=jdoe"

Эта команда выполняет поиск по LDAP с базой поиска (search base), установленной в корне домена (-b "dc=acme,dc=com"), и фильтром, ориентированным на учетную запись пользователя (sAMAccountNam=jdoe), возвращая атрибуты для указанного пользователя:

![image](https://user-images.githubusercontent.com/119851242/206203882-99feeb0f-fa40-4ff0-87a0-99de82efc9e3.png)


Поскольку в этом случае DN пользователя — CN=John Doe,CN=Users,DC=acme,DC=com [5], мы должны настроить **Базы поиска пользователя (User Search Base)** с родительским узлом DN CN=Users,DC= acme,DC =com.

Аналогично, на основе DN группы, на которую ссылается атрибут **memberOf** [4], правильным значением для **Базы поиска группы (Group Search Base)** будет родительский узел этого значения, т.е. OU=Groups,DC=acme,DC=com.
## Определите схему пользователя
  Выходные данные приведенного выше запроса ldapsearch также позволяют определить правильные значения для использования в конфигурации схемы пользователя:

- Object Class: **person** [1]
- Username Attribute: **name** [2]
- Login Attribute: **sAMAccountName** [3]
- User Member Attribute: **memberOf** [4]

Если бы пользователи AD в нашей организации проходили аутентификацию с помощью своего UPN (например, jdoe@acme.com) вместо сокращенного входа в систему, то нам бы пришлось установить **userPrincipalName** в качестве Login Attribute.
## Определите схему группы
  Далее мы отправим запрос об одной из групп, связанных с этим пользователем, в данном случае CN=examplegroup,OU=Groups,DC=acme,DC=com:

$ ldapsearch -x -D "acme\jdoe" -w "secret" -p 389 \

-h ad.acme.com -b "ou=groups,dc=acme,dc=com" \

-s sub "CN=examplegroup"

Эта команда проинформирует нас об атрибутах, используемых для объектов группы:

![image](https://user-images.githubusercontent.com/119851242/206204042-c0320495-e4ed-482c-8ecd-a3ed0405fffc.png)

Опять же, это позволяет нам определить правильные значения для того, чтобы ввести их в конфигурацию схемы группы:

- Object Class: **group** [1]
- Name Attribute: **name** [2]
- Group Member Mapping Attribute: **member** [3]
- Search Attribute: **sAMAccountName** [4]

  Глядя на значение атрибута **member**, мы можем видеть, что он содержит DN пользователя, на которого ссылаются. Это соответствует атрибуту **distinguishedName** в нашем объекте пользователя. Соответственно, придется установить значение параметра Group Member User Attribute для этого атрибута.

  Таким же образом, мы можем наблюдать, что значение в атрибуте **memberOf** в объекте пользователя соответствует **distinguishedName** [5] группы. Поэтому нам нужно установить значение параметра Group DN Attribute равным этому атрибуту.
# Приложение: Устранение неполадок
  Если при тестировании подключения к серверу Active Directory возникают проблемы, сначала дважды проверьте учетные данные, введенные для учетной записи сервиса, а также конфигурацию базы поиска (search base). Вы также можете просмотреть журналы Rancher, чтобы точно определить причину проблемы. Журналы отладки (debug logs) могут содержать более подробную информацию об ошибке. Пожалуйста, обратитесь к разделу "Как я могу включить ведение журнала отладки"  в этой документации.





[^1]: 
[^2]: ` `*"Ошибка создания SSL-соединения: код результата LDAP 200 "Сетевая ошибка": x509: сертификат полагается на устаревшее поле Common Name, используйте SANs или временно включите сопоставление Common Name с GODEBUG=x509ignoreCN=0"*
