Начиная с Rancher v2.5 конвейеры развертывания на основе Git устарели. Мы рекомендуем обрабатывать конвейеры с помощью Rancher Continuous Delivery на базе [Fleet](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/pipelines/%7B%7B%3Cbaseurl%3E%7D%7D/rancher/v2.6/en/deploy-across-clusters/fleet) . Чтобы перейти к Fleet в Rancher, нажмите **☰ > Continuous Delivery (Непрерывная доставка) .**

**Примечание:**
-	Конвейеры в Kubernetes 1.21+ больше не поддерживаются.
-	Fleet не заменяет конвейеры Rancher; разница в том, что конвейеры Rancher теперь поддерживаются Fleet.

Конвейер Rancher обеспечивает простой процесс CI/CD. Используйте его для автоматической проверки кода, запуска сборок или сценариев, публикации образов Docker или каталогов приложений и развертывания обновленного программного обеспечения для пользователей.

Настройка конвейера может помочь разработчикам выпускать новое программное обеспечение максимально быстро и эффективно. Используя Rancher, вы можете интегрироваться с репозиторием GitHub для настройки конвейера непрерывной интеграции (CI).

После настройки Rancher и GitHub вы можете развернуть контейнеры с Jenkins для автоматизации выполнения конвейера:

-	Создайте свое приложение от кода к изображению.
-	Подтвердите свои сборки.
-	Разверните образы сборки в своем кластере.
-	Запустите модульные тесты.
-	Запустите регрессионные тесты.

***Примечание.** Конвейер Rancher обеспечивает простой процесс CI/CD, но он не предлагает полной мощности и гибкости и не является заменой Jenkins корпоративного уровня или других инструментов CI, используемых вашей командой.*

В этом разделе рассматриваются следующие темы:

-	[Концепции](https://github.com/markizz01/test/blob/main/pipelines/_index.md#%D0%BA%D0%BE%D0%BD%D1%86%D0%B5%D0%BF%D1%86%D0%B8%D0%B8)
-	[Как работают конвейеры](https://github.com/markizz01/test/blob/main/pipelines/_index.md#%D0%BA%D0%B0%D0%BA-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D1%8E%D1%82-%D0%BA%D0%BE%D0%BD%D0%B2%D0%B5%D0%B9%D0%B5%D1%80%D1%8B)
-	[Управление доступом на основе ролей для конвейеров](https://github.com/markizz01/test/blob/main/pipelines/_index.md#%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BE%D0%BC-%D0%BD%D0%B0-%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%B5-%D1%80%D0%BE%D0%BB%D0%B5%D0%B9-%D0%B4%D0%BB%D1%8F-%D0%BA%D0%BE%D0%BD%D0%B2%D0%B5%D0%B9%D0%B5%D1%80%D0%BE%D0%B2)
-	[Настройка конвейеров](https://github.com/markizz01/test/blob/main/pipelines/_index.md#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BA%D0%BE%D0%BD%D0%B2%D0%B5%D0%B9%D0%B5%D1%80%D0%BE%D0%B2)
    +	[Настройка поставщиков контроля версий](https://github.com/markizz01/test/blob/main/pipelines/_index.md#1-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BF%D1%80%D0%BE%D0%B2%D0%B0%D0%B9%D0%B4%D0%B5%D1%80%D0%BE%D0%B2-%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D1%8F-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B9-version-control-providers)
    +	[Настроить репозитории](https://github.com/markizz01/test/blob/main/pipelines/_index.md#2-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B5%D0%B2)
    +	[Настроить конвейер](https://github.com/markizz01/test/blob/main/pipelines/_index.md#3-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BA%D0%BE%D0%BD%D0%B2%D0%B5%D0%B9%D0%B5%D1%80%D0%B0)
-	[Справочник по конфигурации конвейера](https://github.com/markizz01/test/blob/main/pipelines/_index.md#%D1%81%D0%BF%D1%80%D0%B0%D0%B2%D0%BE%D1%87%D0%BD%D0%B8%D0%BA-%D0%BF%D0%BE-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8-%D0%BA%D0%BE%D0%BD%D0%B2%D0%B5%D0%B9%D0%B5%D1%80%D0%B0)
-	[Запуск ваших конвейеров](https://github.com/markizz01/test/blob/main/pipelines/_index.md#%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-%D0%B2%D0%B0%D1%88%D0%B8%D1%85-%D0%BA%D0%BE%D0%BD%D0%B2%D0%B5%D0%B9%D0%B5%D1%80%D0%BE%D0%B2)
-	[Запуск конвейера](https://github.com/markizz01/test/blob/main/pipelines/_index.md#%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-%D0%BA%D0%BE%D0%BD%D0%B2%D0%B5%D0%B9%D0%B5%D1%80%D0%B0)
    +	[Изменение триггеров событий для репозитория](https://github.com/markizz01/test/blob/main/pipelines/_index.md#%D0%B8%D0%B7%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5-%D1%82%D1%80%D0%B8%D0%B3%D0%B3%D0%B5%D1%80%D0%BE%D0%B2-%D1%81%D0%BE%D0%B1%D1%8B%D1%82%D0%B8%D0%B9-%D0%B4%D0%BB%D1%8F-%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D1%8F)

# Концепции

Для объяснения понятий и терминологии, используемых в этом разделе, обратитесь к [этой странице.](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/pipelines/%7B%7B%3Cbaseurl%3E%7D%7D/rancher/v2.6/en/pipelines/concepts)

# Как работают конвейеры

После включения возможности использования конвейеров в проекте вы можете настроить несколько конвейеров в каждом проекте. Каждый конвейер уникален и может быть настроен независимо.

Конвейер настраивается для группы файлов, которые возвращаются в репозитории исходного кода. Пользователи могут настраивать свои конвейеры либо через пользовательский интерфейс Rancher, либо путем добавления файла .rancher-pipeline.yml в репозиторий.
Перед настройкой конвейеров вам необходимо настроить аутентификацию для вашего поставщика управления версиями, например, GitHub, GitLab, Bitbucket. Если вы не настроили поставщика управления версиями, вы всегда можете использовать [примеры репозиториев Rancher](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/pipelines/%7B%7B%3Cbaseurl%3E%7D%7D/rancher/v2.6/en/pipelines/example-repos) для просмотра некоторых распространенных развертываний конвейера.

Когда вы настраиваете конвейер в одном из своих проектов, пространство имен специально для этого конвейера создается автоматически. На него развернуты следующие компоненты:

-	**Jenkins:**
Механизм сборки конвейера. Поскольку пользователи проекта не взаимодействуют с Jenkins напрямую, он управляем и заблокирован.
Примечание. Нельзя использовать существующие развертывания Jenkins в качестве механизма конвейера.
-	**Docker Registry:**
По умолчанию целью вашего шага сборки-публикации по умолчанию является внутренний реестр Docker. Однако вместо этого вы можете сделать настройки для отправки в удаленный реестр. Внутренний реестр Docker доступен только с узлов кластера и не может быть напрямую доступен пользователям. Образы не сохраняются по истечении срока службы конвейера и должны использоваться только в запусках конвейера. Если вам нужен доступ к вашим образам за пределами конвейера, отправьте их во внешний реестр.
-	**Minio:**
Хранилище Minio используется для хранения журналов выполнения конвейера.

***Примечание .** Управляемый экземпляр Jenkins работает без сохранения состояния, поэтому не беспокойтесь о сохранении его данных. Экземпляры Docker Registry и Minio по умолчанию используют эфемерные тома, что подходит для большинства случаев использования. Если вы хотите, чтобы журналы конвейера могли пережить сбои узлов, вы можете настроить для них постоянные тома, как описано в разделе Сохраняемость данных для компонентов конвейера .*

# Управление доступом на основе ролей для конвейеров

Если у вас есть доступ к проекту, вы можете включить репозитории, чтобы начать создание конвейеров.

Только администраторы , владельцы или участники кластера или владельцы проектов могут настраивать поставщиков контроля версий и управлять глобальными параметрами выполнения конвейера.

Участники проекта могут настраивать только репозитории и конвейеры.

# Настройка конвейеров

**Необходимое условие:** поскольку приложение конвейеров устарело в пользу Fleet, перед использованием конвейеров необходимо включить флаг функции для устаревших функций. Обратите внимание, что конвейеры в Kubernetes 1.21+ больше не поддерживаются.

1.	В левом верхнем углу нажмите **☰ > Global Settings (Глобальные настройки) .**
2.	Нажмите **«Feature Flags (Флажки функций)» .**
3.	Перейдите к  флажку функции legacy и нажмите **⋮ > Activate (Активировать) .**

## 1. Настройка провайдеров контроля версий Version Control Providers

Прежде чем вы сможете начать настройку конвейера для вашего репозитория, вы должны настроить и авторизовать поставщика управления версиями:
-	GitHub
-	GitLab
-	Bitbucket
-	
Выберите вкладку вашего провайдера ниже и следуйте инструкциям.

**GitHub**

1.	В левом верхнем углу нажмите **☰ > Управление кластером .**
2.	Перейдите в кластер, где вы хотите настроить конвейеры, и нажмите **Исследовать .**
3.	В раскрывающемся меню на верхней панели навигации выберите проект, в котором вы хотите настроить конвейеры.
4.	На левой панели навигации нажмите **Legacy > Project > Pipelines («Устаревшие» > «Проект» > «Конвейеры») .**
5.	Щелкните вкладку **Configuration (Конфигурация) .**
6.	Следуйте инструкциям, отображаемым для **Setup a Github application (настройки приложения Github) .** Rancher перенаправляет вас на Github для настройки приложения OAuth в Github.
7.	С GitHub скопируйте **Client ID и Client Secret .** Вставьте их в Rancher.
8.	Если вы используете GitHub для организации(корпоративную), выберите **Use a private github enterprise installation (Использовать частную установку github для организации) .** Введите адрес хоста вашей установки GitHub.
9.	Щелкните **Authenticate (Аутентифицировать) .**

**GitLab**

1.	В левом верхнем углу нажмите **☰ > Управление кластером .**
2.	Перейдите в кластер, где вы хотите настроить конвейеры, и нажмите **Исследовать .**
3.	В раскрывающемся меню на верхней панели навигации выберите проект, в котором вы хотите настроить конвейеры.
4.	На левой панели навигации нажмите **«Устаревшие» > «Проект» > «Конвейеры» .**
5.	Щелкните вкладку **Конфигурация .**
6.	Щелкните **GitLab .**
7.	Следуйте инструкциям, отображаемым для **настройки приложения GitLab .** Rancher перенаправляет вас на GitLab.
8.	Из GitLab скопируйте **Application ID и Secret .** Вставьте их в Rancher.
9.	Если вы используете GitLab для корпоративной установки, выберите **Использовать частную корпоративную установку gitlab .** Введите адрес хоста вашей установки GitLab.
10.	Щелкните **Аутентифицировать .**

**Примечание:**
1.	Pipeline(конвейер) использует [API Gitlab v4](https://docs.gitlab.com/ee/api/v3_to_v4.html), а поддерживаемая версия Gitlab — 9.0+.
2.	Если вы используете GitLab 10.7+ и ваша установка Rancher находится в локальной сети, включите параметр **Allow requests to the local network from hooks and services (Разрешить запросы к локальной сети от подключений и сервисов)** в настройках администратора GitLab. 

**Bitbucket Cloud**

1.	В левом верхнем углу нажмите **☰ > Управление кластером .**
2.	Перейдите в кластер, где вы хотите настроить конвейеры, и нажмите **Исследовать .**
3.	В раскрывающемся меню на верхней панели навигации выберите проект, в котором вы хотите настроить конвейеры.
4.	На левой панели навигации нажмите **«Устаревшие» > «Проект» > «Конвейеры» .**
5.	Щелкните вкладку **Конфигурация .**
6.	Щелкните **Bitbucket** и оставьте значение **Use private Bitbucket Server setup (Использовать Bitbucket Cloud)** выбранным по умолчанию.
7.	Следуйте инструкциям, отображаемым для настройки приложения **Bitbucket Cloud .** Rancher перенаправляет вас в Bitbucket для настройки потребителя OAuth в Bitbucket.
8.	Из Bitbucket скопируйте **Key (ключ)** потребителя и **Secret (секрет) .** Вставьте их в Rancher.
9.	Щелкните **Аутентифицировать .**

**Bitbucket Server**

1.	В левом верхнем углу нажмите **☰ > Управление кластером .**
2.	Перейдите в кластер, где вы хотите настроить пайплайны, и нажмите **Исследовать .**
3.	В раскрывающемся меню на верхней панели навигации выберите проект, в котором вы хотите настроить конвейеры.
4.	На левой панели навигации нажмите **«Устаревшие» > «Проект» > «Конвейеры» .**
5.	Щелкните вкладку **Конфигурация .**
6.	Нажмите **Bitbucket** и выберите параметр **«  Use private Bitbucket Server setup (Использовать частную установку Bitbucket Server) ».**
7.	Следуйте инструкциям, отображаемым для настройки приложения **Bitbucket Server .**
8.	Введите адрес хоста установки вашего сервера Bitbucket.
9.	Щелкните **Аутентифицировать .**

***Примечание.** Сервер Bitbucket должен выполнять проверку SSL при отправке веб-перехватчиков на Rancher. Убедитесь, что сервер Bitbucket доверяет сертификату сервера Rancher.*
Есть два варианта:
1.	Настройте сервер Rancher с сертификатом доверенного центра сертификации.
2.	Если вы используете самозаверяющиеся сертификаты, импортируйте сертификат сервера Rancher на сервер Bitbucket. Инструкции см. в документации сервера Bitbucket по [настройке самозаверяющих сертификатов .](https://confluence.atlassian.com/bitbucketserver/if-you-use-self-signed-certificates-938028692.html)

**Результат:** после аутентификации поставщика управления версиями вы будете автоматически перенаправлены, чтобы начать настройку репозиториев, которые вы хотите начать использовать с конвейером.

## 2. Конфигурация репозиториев

После авторизации поставщика управления версиями вы автоматически перенаправляетесь к началу настройки репозиториев, с которыми вы хотите начать использовать конвейеры. Даже если поставщик управления версиями настроил кто-то другой, вы увидите его репозитории и сможете создать конвейер.

1.	В левом верхнем углу нажмите **☰ > Управление кластером .**
2.	Перейдите в кластер, где вы хотите настроить конвейеры, и нажмите **Исследовать .**
3.	В раскрывающемся меню на верхней панели навигации выберите проект, в котором вы хотите настроить конвейеры.
4.	На левой панели навигации нажмите **«Устаревшие» > «Проект» > «Конвейеры» .**
5.	Нажмите **Configure Repositories («Настроить репозитории ») .**
6.	Отобразится список репозиториев. Если вы настраиваете репозитории в первый раз, нажмите **Authorize & Fetch Your Own Repositories (« Авторизовать и получить свои собственные репозитории »), чтобы получить список репозиториев.
7.	Для каждого репозитория, для которого вы хотите настроить конвейер, нажмите **Enable « Включить » .**
8.	Когда вы закончите включение всех своих репозиториев, нажмите **Done «Готово » .**

**Результаты:** у вас есть список репозиториев, для которых вы можете начать настройку конвейеров.

## 3. Настройка конвейера

Теперь, когда репозитории добавлены в ваш проект, вы можете приступить к настройке конвейера, добавив автоматизированные этапы и шаги. Для вашего удобства существует несколько встроенных типов шагов для специальных задач.
1.	В левом верхнем углу нажмите **☰ > Управление кластером .**
2.	Перейдите в кластер, где вы хотите настроить конвейеры, и нажмите **Исследовать .**
3.	В раскрывающемся меню на верхней панели навигации выберите проект, в котором вы хотите настроить конвейеры.
4.	На левой панели навигации нажмите **«Устаревшие» > «Проект» > «Конвейеры» .**
5.	Найдите репозиторий, для которого вы хотите настроить конвейер.
6.	Настройте конвейер через пользовательский интерфейс или с помощью файла yaml в репозитории, т.е.  .rancher-pipeline.yml или .rancher-pipeline.yaml. Конфигурация конвейера разбита на этапы и шаги. Этапы должны быть полностью завершены, прежде чем переходить к следующему этапу, но шаги на этапе выполняются одновременно. Для каждого этапа вы можете добавить разные типы шагов. Примечание. При построении каждого шага существуют различные дополнительные параметры в зависимости от типа шага. Дополнительные параметры включают правила запуска, переменные среды и секреты. Дополнительные сведения о настройке конвейера с помощью пользовательского интерфейса или файла YAML [см . в справочнике по настройке конвейера.](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/pipelines/%7B%7B%3Cbaseurl%3E%7D%7D/rancher/v2.6/en/pipelines/config)
    -	Если вы собираетесь использовать пользовательский интерфейс, выберите вертикальный **⋮ > Edit Config (Изменить конфигурацию)**, чтобы настроить конвейер с помощью пользовательского интерфейса. После настройки конвейера необходимо просмотреть файл YAML и отправить его в репозиторий.
    -	Если вы собираетесь использовать файл YAML, выберите вертикальный **⋮ > View/Edit YAML  (Просмотр/редактирование YAML)** , чтобы настроить конвейер. Если вы решите использовать файл YAML, вам необходимо отправить его в репозиторий после любых изменений, чтобы он обновился в репозитории. При редактировании конфигурации конвейера Rancher требуется несколько секунд, чтобы проверить существующую конфигурацию конвейера.
7.	Выберите, какой branch использовать из списка ветвей.
8.	Необязательно/опционно: Настройте уведомления.
9.	Настройте правила триггера для конвейера.
10.	Введите **Timeout (время ожидания)** для конвейера.
11.	Когда все этапы и шаги настроены, нажмите **« Done (Готово) » .**
**Результат.** Теперь ваш конвейер настроен и готов к запуску.

# Справочник по конфигурации конвейера

Обратитесь к [этой странице](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/pipelines/%7B%7B%3Cbaseurl%3E%7D%7D/rancher/v2.6/en/pipelines/config) для получения подробной информации о том, как настроить конвейер для:
-	Запуска скрипта
-	Создания и публикации изображения
-	Публикации шаблонов каталога
-	Развертывания YAML
-	Развертывания приложение каталога

Справочник по конфигурации также описывает, как настроить:

-	Уведомления
-	Время ожидания
-	Правила, запускающие конвейер
-	Переменные среды
-	Секреты

# Запуск ваших конвейеров

Запустите конвейер в первый раз. Найдите свой конвейер и выберите вертикальный **⋮ > Run (Выполнить) .**

Во время начального запуска ваш конвейер тестируется, и следующие компоненты конвейера разворачиваются в вашем проекте в качестве рабочих нагрузок в новом пространстве имен, выделенном для конвейера:
-	docker-registry
-	jenkins
-	minio

Этот процесс занимает несколько минут. Когда он завершится, вы сможете просмотреть каждый компонент конвейера на вкладке **«Workloads (Рабочие нагрузки) »** проекта .

# Запуск конвейера

Когда репозиторий включен, webhook автоматически устанавливается в поставщике управления версиями. По умолчанию конвейер запускается **Push (отправкой)** события в репозиторий, но вы можете изменить события, запускающие конвейер.

Доступные события:

-	Push : Всякий раз, когда фиксация отправляется в ветку в репозитории, запускается конвейер.
-	Pull Request (Запрос на извлечение): всякий раз, когда в репозиторий отправляется запрос на извлечение, запускается конвейер.
-	Tag : при создании тега в репозитории запускается конвейер.

***Примечание.** Эта опция не существует для примеров репозиториев Rancher .*

# Изменение триггеров событий для репозитория

1.	В левом верхнем углу нажмите **☰ > Управление кластером .**
2.	Перейдите в кластер, где вы хотите настроить конвейеры, и нажмите **Исследовать .**
3.	В раскрывающемся меню на верхней панели навигации выберите проект, в котором вы хотите настроить конвейеры.
4.	На левой панели навигации нажмите **«Устаревшие» > «Проект» > «Конвейеры» .**
5.	Найдите репозиторий, в котором вы хотите изменить триггеры событий. Выберите вертикальный **⋮ > Setting. (Настройка) .**
6.	Выберите, какие триггеры событий **( Push , Pull Request или Tag )** вы хотите использовать для репозитория.
7.	Нажмите **Save (Сохранить) .**
