Начиная с версии 2.5 функция ведения журнала, доступная в Rancher, была полностью переработана. [Был принят оператор логирования](https://github.com/banzaicloud/logging-operator)  https://github.com/banzaicloud/logging-operator  от Banzai Cloud.  Rancher настраивает этот инструментарий для использования при развертывании ведения журнала.

Среди множества функций и изменений в новой функции ведения журнала — удаление конфигураций ведения журнала для конкретных проектов. Вместо этого теперь можно настроить ведение журнала на уровне пространства имен. Ведение журнала на уровне кластера остается доступным, но параметры конфигурации различаются.

+	Монтаж
    -	Терминология
+	Ведение журнала кластера
+	Ведение журнала проекта
+	Выходная конфигурация
    -	Эластичный поиск
    -	Splunk
    -	Кафка
    -	свободно
    -	системный журнал
+	Пользовательские поля журнала
+	Системный журнал


# Монтаж

Чтобы установить ведение журнала в Rancher v2.5+, обратитесь к инструкции по установке . https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/logging/migrating/%7B%7B%3Cbaseurl%3E%7D%7D/rancher/v2.6/en/logging/ 

## Терминология

В версии 2.5+ регистрация конфигурации в Cluster Dashboard . Чтобы настроить ведение журнала пользовательских ресурсов после установки приложения Logging, перейдите на левую панель навигации и щелкните Logging . Именно из этого пункта меню настраивается ведение журнала как для кластера, так и для пространства имен.

*Примечание. Ведение журнала устанавливается отдельно для каждого кластера. Вам нужно будет перемещаться между кластерами, чтобы настроить ведение журнала для каждого кластера.*

Существует четыре ключевых концепции ведения журнала версии 2.5+, которые необходимо понимать:

1.	Выходы
Outputs являются ресурсом конфигурации, определяющим место назначения для собранных журналов. Здесь хранятся настройки таких агрегаторов, как ElasticSearch, Kafka и т. д. Outputs являются ресурсами пространства имен.
2.	Потоки
Flows— это ресурс конфигурации, определяющий правила сбора, фильтрации и назначения для журналов. Именно в потоке можно настроить, какие журналы собирать, как их видоизменять или фильтровать и куда отправлять журналы Outputs. Flows являются ресурсами пространства имен и могут подключаться либо к Output в том же пространстве имен, либо к ClusterOutput.
3.	Выходы кластера
ClusterOutputs выполняют те же функции что и Outputs, за исключением того, что они являются ресурсом с областью действия кластера. ClusterOutputs необходимы при сборе журналов по всему кластеру или если вы хотите предоставить Output все пространства имен в вашем кластере.
4.	Кластерные потоки
ClusterFlows выполняют ту же функцию, что и Flows, но на уровне кластера. Они используются для настройки сбора журналов для всего кластера, а не на уровне пространства имен. ClusterFlows также как Flows функционален, где определены изменения и фильтры.

# Ведение журнала кластера

Чтобы настроить ведение журнала на уровне кластера для ведения журнала версии 2.5+, необходимо настроить файл ClusterFlow. Этот объект определяет источник журналов, любые применяемые преобразования или фильтры и, наконец, Output(или Outputs) для журналов.

*Важно: ClusterFlows должен быть определен в cattle-logging-system пространстве имен. ClusterFlows не будет работать, если он определен в любом другом пространстве имен.*

В устаревшем ведении журналов для сбора журналов со всего кластера нужно было только включить ведение журнала на уровне кластера и определить желаемый файл Output. Этот базовый подход остается в ведении журнала версии 2.5+. Чтобы реплицировать устаревшее ведение журнала на уровне кластера, выполните следующие действия.

1.	Определите ClusterOutput в соответствии с инструкциями в разделе [«Конфигурация вывода».](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/logging/migrating/_index.md#output-configuration)
2.	Создайте ClusterFlow, убедившись, что он настроен для создания в пространстве имен cattle-logging-system 
    1.	Удалите из определения все правила включения и исключения Flow . Это гарантирует, что все журналы будут собраны.
    2.	Вам не нужно настраивать какие-либо фильтры, если вы этого не хотите - поведение по умолчанию не требует их создания
    3.	Определите свой кластер Output или Outputs
Это приведет к тому, что журналы из всех источников в кластере (все модули и все системные компоненты) будут собираться и отправляться в Output или указанное вами Outputs в файле ClusterFlow.

# Ведение журнала проекта

Вход в v2.5+ не зависит от проекта. Это означает, что для сбора журналов из модулей, работающих в пространствах имен проекта, вам необходимо определить Flows для этих пространств имен.

Чтобы собрать журналы из определенного пространства имен, выполните следующие действия.

1.	Определите Output или ClusterOutput в соответствии с инструкциями в разделе [«Конфигурация вывода».](https://github.com/rancher/docs/blob/master/content/rancher/v2.6/en/logging/migrating/_index.md#output-configuration)
3.	Создайте файл Flow, убедившись, что он настроен для создания в пространстве имен, в котором вы хотите собирать журналы.
    1.	Если вы хотите определить правила включения или исключения, вы можете это сделать. В противном случае удаление всех правил приведет к тому, что все модули в целевом пространстве имен будут собирать свои журналы.
    2.	Вам не нужно настраивать какие-либо фильтры, если вы этого не хотите - поведение по умолчанию не требует их создания
    3.	Определите свои выходы - это могут быть либо объекты ClusterOutput, либо Output объекты.


Это приведет к тому, что журналы из всех источников в пространстве имен (модулях) будут собираться и отправляться в Output(или Outputs), которые вы определили в своем файле Flow.

Чтобы собрать журналы из проекта, повторите описанные выше шаги для каждого пространства имен в проекте. Кроме того, вы можете пометить рабочие нагрузки вашего проекта общей меткой (например, project=my-project) и использовать ClusterFlow для сбора журналов со всех модулей, соответствующих этой метке.

# Выходная конфигурация

В устаревшем ведении журнала можно выбрать одно из пяти направлений ведения журнала: Elasticsearch, Splunk, Kafka, Fluentd и Syslog. За исключением системного журнала, все эти назначения доступны в ведении журнала версии 2.5+.

## Elasticsearch

|Устаревшее ведение журнала	|v2.5+ Ведение журнала|	Заметки|
|:-|:-|:-|
|Конечная точка	|Цель -> Хост	|Обязательно укажите Схему (https/http), а также Порт|
|X-Pack Безопасность -> Имя пользователя|	Доступ -> Пользователь||	
|езопасность X-Pack -> Пароль	|Доступ -> Пароль	|Пароль теперь должен храниться в секрете|
|Конфигурация SSL -> Закрытый ключ клиента	|SSL -> Ключ клиента	|Ключ теперь должен храниться в секрете|
|Конфигурация SSL -> Сертификат клиента	|SSL -> Сертификат клиента	|Сертификат теперь должен храниться в секрете|
|Конфигурация SSL -> Пароль ключа клиента	|SSL -> Передача ключа клиента	|Пароль теперь должен храниться в секрете|
|Конфигурация SSL -> Включенная проверка SSL	|SSL -> Файл центра сертификации	|Сертификат теперь должен храниться в секрете|


В устаревшем журналировании индексы создавались автоматически в соответствии с форматом, указанным в разделе «Шаблоны индексов». В ведении журнала версии 2.5 поведение по умолчанию было изменено на ведение журнала в один индекс. Вы по-прежнему можете настроить функциональность шаблона индекса для Output объекта, отредактировав его как YAML и введя следующие значения:
```
...
spec:
  elasticsearch:
    ...
    logstash_format: true
    logstash_prefix: <desired prefix>
    logstash_dateformat: "%Y-%m-%d"
 ```
 
Замените <desired prefix> префиксом индексов, которые будут созданы. В устаревшем ведении журнала по умолчанию используется имя кластера.
  
## Splunk

|Устаревшее ведение журнала	|v2.5+ Ведение журнала	|Заметки|
|Конфигурация HEC -> Конечная точка	|Цель -> Хост	|Протокол (https/http) и порт должны быть определены отдельно от хоста|
|Конфигурация HEC -> Токен	|Доступ -> Токен	|Токен теперь должен храниться как секрет|
|Конфигурация HEC -> Индекс	|Изменить как YAML ->index	|Index поле должно быть добавлено как ключ YAML под spec.splunkHec|
|Конфигурация HEC -> Источник	|Изменить как YAML ->source	|Source поле должно быть добавлено как ключ YAML под spec.splunkHec|
|Конфигурация SSL -> Закрытый ключ клиента	|Изменить как YAML ->client_key	|client_key поле должно быть добавлено как ключ YAML в разделе spec.splunkHec. См. (1)|
|Конфигурация SSL -> Сертификат клиента	|Изменить как YAML ->client_cert	|client_cert поле должно быть добавлено как ключ YAML в разделе spec.splunkHec. См. (1)|
|Конфигурация SSL -> Пароль ключа клиента	|Не поддерживается	|Указание пароля для закрытого ключа клиента в настоящее время не поддерживается.|
|Конфигурация SSL -> Проверка SSL	|Изменить как YAML -> ca_file или ca_path |ca_file или ca_path поле должно быть добавлено как ключ YAML в разделе spec.splunkHec. См. (2)|
 
*(1) client_keyи client_cert значения должны быть путями к файлам ключей и сертификатов соответственно. Эти файлы должны быть смонтированы вмодуле rancher-logging-fluentd, чтобы их можно было использовать.
(2) Пользователи могут настроить либо ca_file(путь к сертификату ЦС в формате PEM), либо ca_path(путь к каталогу, содержащему сертификаты ЦС в формате PEM). Эти файлы должны быть смонтированы в модуле rancher-logging-fluentd, чтобы их можно было использовать.*
 
## Kafka
  
|Устаревшее ведение журнала	|v2.5+ Ведение журнала	|Заметки|
|:-|:-|:-|
|Конфигурация Kafka -> Тип конечной точки	|-	|Zookeeper больше не поддерживается в качестве типа конечной точки.|
|Конфигурация Кафки -> Конечная точка	|Цель -> Брокеры	|Список брокеров через запятую (хост:порт)|
|Конфигурация Кафки -> Тема	|Цель -> Тема по умолчанию	||
|Конфигурация SSL -> Закрытый ключ клиента	|SSL -> сертификат клиента SSL	|Сертификат должен храниться как секрет|
|Конфигурация SSL -> Сертификат клиента	|SSL -> Ключ сертификата клиента SSL	|Ключ должен храниться как секрет|
|Конфигурация SSL -> Сертификат ЦС PEM	|SSL -> сертификат SSL CA	|Сертификат должен храниться как секрет|
|Конфигурация SASL -> Имя пользователя	|Доступ -> Имя пользователя	|Имя пользователя должно храниться в секрете|
|Конфигурация SASL -> Пароль	|Доступ -> Пароль	|Пароль должен храниться в секрете|
|Конфигурация SASL -> Механизм блокировки	|Доступ -> Механизм Scram	|Механизм ввода в виде строки, например "sha256" или "sha512"|

## Fluentd

 Начиная с версии 2.5.2 можно добавить только один сервер Fluentd с помощью параметра «Редактировать как форму». Чтобы добавить несколько серверов, отредактируйте файл Output как YAML и введите несколько серверов.

|Устаревшее ведение журнала	|v2.5+ Ведение журнала	|Заметки|
|Конфигурация Fluentd -> Конечная точка	|Цель -> Хост, Порт	|Введите хост и порт отдельно|
|Конфигурация Fluentd -> Общий ключ	|Доступ -> Общий ключ	|Общий ключ должен храниться как секрет|
|Конфигурация Fluentd -> Имя пользователя	|Доступ -> Имя пользователя|	Имя пользователя должно храниться в секрете|
|Конфигурация Fluentd -> Пароль	|Доступ -> Пароль	|Пароль должен храниться в секрете|
|Конфигурация Fluentd -> Имя хоста	|Изменить как YAML ->host	|Host поле установлено как ключ YAML под spec.forward.servers[n]|
|Конфигурация Fluentd -> Вес	|Изменить как YAML ->weight	|weight поле установлено как ключ YAML под spec.forward.servers[n]|
|Конфигурация SSL -> Использовать TLS	|-	|Не нужно явно включать. Вместо этого определите поля сертификата клиента.|
|Конфигурация SSL -> Закрытый ключ клиента	|Изменить как YAML ->tls_private_key_path	|Поле, заданное как ключ YAML в разделе spec.forward. См. (1)|
|Конфигурация SSL -> Сертификат клиента	|Изменить как YAML ->tls_client_cert_path|	Поле, заданное как ключ YAML в разделе spec.forward. См. (1)|
|Конфигурация SSL -> Пароль ключа клиента	|Изменить как YAML ->tls_client_private_key_passphrase	|Поле, заданное как ключ YAML в разделе spec.forward. См. (1)|
|Конфигурация SSL -> Проверка SSL	|Изменить как YAML ->tls_insecure_mode	|Поле, заданное как ключ YAML в разделе spec.forward. По умолчанию:false|
|Конфигурация SSL -> Сертификат ЦС PEM	|Изменить как YAML ->tls_cert_path	|Поле, заданное как ключ YAML в разделе spec.forward. См. (1)|
|Включить сжатие Gzip|	-	|Больше не поддерживается в ведении журнала v2.5+|
  
*(1) Эти значения указываются как пути к файлам. Эти файлы должны быть смонтированы в модуле rancher-logging-fluentd, чтобы их можно было использовать.*

## Syslog

Начиная с версии 2.5.2, системный журнал в настоящее время не поддерживается для Outputs, используя ведение журнала версии 2.5+.
  
# Пользовательские поля журнала
Чтобы добавить настраиваемые поля журнала, вам потребуется добавить в конфигурацию Flow следующий YAML:
  
```
...
spec:
  filters:
    - record_modifier:
        records:
        - foo: "bar"
```
(замените foo: "bar" пользовательскими полями журнала, которые вы хотите добавить)
  
# Системный журнал
  
В устаревшем ведении журнала сбор журналов из системных компонентов осуществлялся путем установки флажка «Включить системный журнал» при настройке ведения журнала кластера. В ведении журнала версии 2.5+ системные журналы собираются одним из двух способов:
  
1.	Соберите все журналы кластера, не указывая никаких правил соответствия или исключения. Это приводит к сбору всех журналов контейнеров из кластера, включая системные журналы.
2.	Настройте таргетинг на системные журналы, добавив правила соответствия для системных компонентов. Конкретные правила сопоставления зависят от собираемого компонента.

